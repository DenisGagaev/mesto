(()=>{"use strict";class e{constructor(e,t,s,r,i,o,n){this._data=e,this._cardSelector=t,this._userId=s,this._cardId=e._id,this._cardOwnerId=e.owner._id,this._imagePopup=r,this._element=this._getTemplate(),this._likeButton=this._element.querySelector(".element__like"),this._deleteButton=this._element.querySelector(".elements__delete"),this._likeCounter=this._element.querySelector(".element__like-counter"),this._deleteCard=i,this._addCardLike=o,this._deleteCardLike=n}_getTemplate(){return document.querySelector(this._cardSelector).content.cloneNode(!0)}generateCard(){this._setEventListeners();const e=this._element.querySelector(".element__image"),t=this._element.querySelector(".element__text");return e.alt=this._data.name,e.src=this._data.link,t.textContent=this._data.name,this._element.querySelector(".element__like-counter").textContent=this._data.likes.length,this._setIsLiked(),this._element}_setEventListeners(){this._cardOwnerId===this._userId&&(this._deleteButton.classList.add("elements__delete_active"),this._deleteButton.addEventListener("click",(e=>this._deleteFotoCard(e)))),this._likeButton.addEventListener("click",(()=>this._toggleLike())),this._element.querySelector(".element__image").addEventListener("click",this._imagePopup)}_toggleLike(){this._likeButton.classList.contains("element__like_active")?this._deleteCardLike(this._cardId).then((e=>{this._data=e,this._likeCounter.textContent=e.likes.length,this._likeButton.classList.remove("element__like_active")})).catch((e=>console.log(e))):this._addCardLike(this._cardId).then((e=>{this._data=e,this._likeCounter.textContent=e.likes.length,this._likeButton.classList.add("element__like_active")})).catch((e=>console.log(e)))}_deleteFotoCard(e){const t={card:this._element,cardId:this._cardId};this._deleteCard(t),e.target.closest(".element").remove()}_setIsLiked(){this._data.likes.some((e=>e._id===this._userId))&&this._likeButton.classList.add("element__like_active")}}const t={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__input-error_visible",inputError:".popup__input-error"};class s{constructor(e,t){this._form=t,this._formSelector=e.formSelector,this._inputSelector=e.inputSelector,this._submitButtonSelector=e.submitButtonSelector,this._inputErrorClass=e.inputErrorClass,this._inactiveButtonClass=e.inactiveButtonClass,this._errorClass=e.errorClass,this._inputError=e.inputError,this._inputs=Array.from(this._form.querySelectorAll(this._inputSelector))}_showInputError(e){this._errorElement=this._form.querySelector("#".concat(e.id,"-error")),e.classList.add(this._inputErrorClass),this._errorElement.classList.add(this._errorClass),this._errorElement.textContent=this._element.validationMessage}_hideInputError(e){this._errorElement=this._form.querySelector("#".concat(e.id,"-error")),e.classList.remove(this._inputErrorClass),this._errorElement.classList.remove(this._errorClass),this._errorElement.textContent=""}_isValid(e){this._element=e,this._element.validity.valid?this._hideInputError(e):this._showInputError(e)}_hasInvalidInput(){return this._inputs.some((e=>!e.validity.valid))}_toggleButtonState(){this._buttonElement.setAttribute("disabled",!0),this._buttonElement.classList.add(this._inactiveButtonClass)}toggleSubmit(){this._hasInvalidInput()?this._toggleButtonState():(this._buttonElement.removeAttribute("disabled",!0),this._buttonElement.classList.remove(this._inactiveButtonClass))}_setEventListeners(){this._buttonElement=this._form.querySelector(this._submitButtonSelector),this._inputs.forEach((e=>{e.addEventListener("input",(()=>{this._isValid(e),this.toggleSubmit()}))}))}enableValidation(){this._setEventListeners(),this._form.addEventListener("submit",(e=>e.preventDefault()),this.toggleSubmit())}hideAllErrors(){this._inputs.forEach((e=>{this._hideInputError(e)})),this._toggleButtonState()}}class r{constructor(e){this._popupSelector=e,this._popupOverlay=this._popupSelector.querySelector(".popup__overlay"),this._closePopup=this._popupSelector.querySelector(".popup__close"),this._handleEscClose=this._handleEscClose.bind(this),this._classOpenedPopup="popup_opened"}open(){document.addEventListener("keydown",this._handleEscClose),this._popupSelector.classList.add(this._classOpenedPopup)}close(){document.removeEventListener("keydown",this._handleEscClose),this._popupSelector.classList.remove(this._classOpenedPopup)}_handleEscClose(e){"Escape"===e.key&&this.close()}setEventListeners(){this._closePopup.addEventListener("click",(()=>{this.close()})),this._popupOverlay.addEventListener("click",(()=>{this._popupSelector.classList.contains(this._classOpenedPopup)&&this.close()}))}}class i extends r{constructor(e,t){let{formSubmitCallBack:s}=t;super(e),this._formSubmitCallBack=s,this._formSubmit=this._formSubmit.bind(this),this._form=this._popupSelector.querySelector(".popup__form"),this._inputs=Array.from(this._form.querySelectorAll(".popup__input")),this._submitButton=this._form.querySelector(".popup__button")}_formSubmit(){this._formSubmitCallBack(this._getInputValues(),this._submitButton)}_getInputValues(){const e={};return this._inputs.forEach((t=>{e[t.name]=t.value})),e}close(){super.close(),this._form.reset()}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",this._formSubmit)}}const o=document.querySelector("#popup__form-profile"),n=document.querySelector("#popup__Profile"),a=document.querySelector("#popup__card"),l=document.querySelector("#popap__image"),_=document.querySelector("#popap__avatar"),c=document.querySelector("#popap__deleteCard"),u=o.querySelector("#popup__name-input"),h=o.querySelector("#popup__text-input"),d=document.querySelector(".profile__name"),p=document.querySelector(".profile__text"),m=document.querySelector(".profile__avatar"),f=document.querySelector(".profile__avatar-batton"),S=document.querySelector(".elements"),v=document.querySelector(".profile__edit"),k=document.querySelector(".profile__addfoto-button"),b=new class{constructor(e){this._baseUrl=e.serverUrl,this._token=e.token}_requestResult(e){return e.ok?e.json():Promise.reject("Хьюстон, у нас проблемы: Ошибка ".concat(e.status," ").concat(e.statusText))}getUserInfo(){return fetch("".concat(this._baseUrl,"users/me"),{headers:{authorization:this._token}}).then((e=>this._requestResult(e)))}editProfile(e){return fetch("".concat(this._baseUrl,"users/me"),{method:"PATCH",headers:{authorization:this._token,"Content-Type":"application/json"},body:JSON.stringify({name:e.name.trim(),about:e.about.trim()})}).then((e=>this._requestResult(e)))}getInitialCards(){return fetch("".concat(this._baseUrl,"cards"),{headers:{authorization:this._token}}).then((e=>this._requestResult(e)))}editAvatar(e){return fetch("".concat(this._baseUrl,"users/me/avatar"),{method:"PATCH",headers:{authorization:this._token,"Content-Type":"application/json"},body:JSON.stringify({avatar:e.avatarLink})}).then((e=>this._requestResult(e)))}sendCard(e){return fetch("".concat(this._baseUrl,"cards"),{method:"POST",headers:{authorization:this._token,"Content-Type":"application/json"},body:JSON.stringify({name:e.name,link:e.link})}).then((e=>this._requestResult(e)))}deleteCard(e){return fetch("".concat(this._baseUrl,"cards/").concat(e),{method:"DELETE",headers:{authorization:this._token}}).then((e=>this._requestResult(e)))}addCardLike(e){return fetch("".concat(this._baseUrl,"cards/likes/").concat(e),{method:"PUT",headers:{authorization:this._token}}).then((e=>this._requestResult(e)))}deleteCardLike(e){return fetch("".concat(this._baseUrl,"cards/likes/").concat(e),{method:"DELETE",headers:{authorization:this._token}}).then((e=>this._requestResult(e)))}}({serverUrl:"https://mesto.nomoreparties.co/v1/cohort-27/",token:"8747a9a0-014b-48d6-8e47-516b00c90197"});let C,E,y;const g=[b.getUserInfo(),b.getInitialCards()],L=new s(t,n),I=new s(t,a),q=new s(t,_);L.enableValidation(),I.enableValidation(),q.enableValidation();const x=e=>{e.textContent="Сохранение..."},B=e=>{e.textContent="Сохранить"},A=e=>{const t={link:e.target.src,text:e.target.closest(".element").querySelector(".element__text").textContent};w.open(t)},w=new class extends r{constructor(e){super(e),this._imageElement=this._popupSelector.querySelector(".popup__photo"),this._popupImageSubtitle=this._popupSelector.querySelector(".popup__image-subtitle")}open(e){let{text:t,link:s}=e;this._imageElement.src=s,this._imageElement.alt=t,this._popupImageSubtitle.textContent=t,super.open()}}(l);w.setEventListeners();const U=e=>{T.data=e,T.open()},P=t=>new e(t,"#cardTemplate",C,A,U,E=e=>b.addCardLike(e),y=e=>b.deleteCardLike(e)).generateCard(t),T=new class extends r{constructor(e,t){let{formSubmitCallBack:s}=t;super(e),this._formSubmitCallBack=s,this._form=this._popupSelector.querySelector(".popup__form"),this._submit=this._submit.bind(this)}_submit(e){e.preventDefault(),this._formSubmitCallBack(this.data)}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",this._submit)}}(c,{formSubmitCallBack:e=>{b.deleteCard(e.cardId).then((()=>{T.close()})).catch((e=>console.log(e)))}});T.setEventListeners();const O=new class{constructor(e,t){let{renderItems:s}=e;this._renderer=s,this._container=t}renderItems(e){e.forEach((e=>{this._renderer(e)}))}addItem(e){this._container.prepend(e)}}({renderItems:e=>{O.addItem(P(e))}},S),R=new i(a,{formSubmitCallBack:(e,t)=>{x(t);const s={name:e.photoText,link:e.photoLink};b.sendCard(s).then((e=>{O.addItem(P(e),!0),R.close()})).catch((e=>console.log(e))).finally((()=>{B(t)}))}});R.setEventListeners();const V=new class{constructor(e){let{profileName:t,profileText:s,profileAvatar:r}=e;this._name=t,this._text=s,this._profileAvatar=r}getUserInfo(){return{name:this._name.textContent,text:this._text.textContent}}setUserInfo(e){this._name.textContent=e.name,this._text.textContent=e.about}setAvatarInfo(e){this._profileAvatar.style.backgroundImage='url("'.concat(e.avatar,'")')}}({profileName:d,profileText:p,profileAvatar:m}),z=new i(n,{formSubmitCallBack:(e,t)=>{x(t),b.editProfile(e).then((e=>{V.setUserInfo(e),z.close()})).catch((e=>console.log(e))).finally((()=>{t.textContent="Создать"}))}});z.setEventListeners();const N=new i(_,{formSubmitCallBack:(e,t)=>{x(t),b.editAvatar(e).then((e=>{V.setAvatarInfo(e),N.close()})).catch((e=>console.log(e))).finally((()=>{B(t)}))}});N.setEventListeners(),v.addEventListener("click",(()=>{const e=V.getUserInfo();L.hideAllErrors(),u.value=e.name,h.value=e.text,z.open()})),k.addEventListener("click",(()=>{R.open(),I.hideAllErrors()})),f.addEventListener("click",(()=>{N.open(),q.enableValidation()})),Promise.all(g).then((e=>{let[t,s]=e;C=t._id,V.setUserInfo(t),V.setAvatarInfo(t),O.renderItems(s.reverse())})).catch((e=>console.log(e)))})();